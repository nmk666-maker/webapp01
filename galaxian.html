<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galaxion 1979 ‚Äì niv√• 3 (sprites)</title>
  <style>
    html,body{height:100%;margin:0;background:#65819e;color:#e7eefc;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{display:grid;place-items:center;height:100%}
    canvas{background:#040710;border:2px solid #2858c7;border-radius:12px;box-shadow:0 10px 30px rgba(113, 7, 7, 0.881);image-rendering:pixelated}
    .hint{position:fixed;inset:auto 0 12px 0;text-align:center;opacity:.85;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="480" height="640"></canvas>
  </div>
  <div class="hint">Pil ‚Üê/‚Üí ‚Ä¢ SPACE skyter ‚Ä¢ R restart ‚Ä¢ 5 liv ‚Ä¢ Fiender skyter & dykker ‚Ä¢ Sprites-basert grafikk</div>

  <script>
  // --- Galaxian-inspirert med sprites (pixel-art tegnet fra matriser) ---
  const W=480,H=640; const ctx=document.getElementById('game').getContext('2d');
  ctx.imageSmoothingEnabled=false;

  // Minimal lyd (valgfrie): sl√• av ved √• sette SOUND=false
  const SOUND=true; let ac=null; function audio(){ if(!SOUND) return; if(!ac){ ac=new (window.AudioContext||window.webkitAudioContext)(); } return ac; }
  function b(freq=440, dur=0.06, type='square', gain=0.04){ const a=audio(); if(!a) return; const o=a.createOscillator(); const g=a.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(a.destination); const t=a.currentTime; o.start(t); o.stop(t+dur); }
  addEventListener('keydown',()=>audio(),{once:true});

  // --- Pixel-art sprites (16x16) -----------------------------------------
  // Bruk en enkel palettkode: . = transparent, bokstaver = farger
  const PALETTE = {
    'G':'#4d652c','S':'#000000','Y':'#ffd166','R':'#960404','K':'#0b0f19','W':'#FFFFFF','P':'#fca5a5','C':'#7dd3fc','L':'#6ee7b7','B':'#2c3a83'
  };

  function drawSprite(grid, x, y, scale=2){
    for(let j=0;j<grid.length;j++){
      const row=grid[j];
      for(let i=0;i<row.length;i++){
        const ch=row[i]; if(ch==='.'||!PALETTE[ch]) continue;
        ctx.fillStyle=PALETTE[ch];
        ctx.fillRect(x+i*scale, y+j*scale, scale, scale);
      }
    }
  }

  // Spiller (lite trekantskip med cockpit)
  const SPR_PLAYER = [
    '................',
    '........W.......',
    '........W.......',
    '.......WWW......',
    '.......WWW......',
    '.....R.WWW.R....',
    '.....W.WRW.W....',
    '...R.BWRWRWB.R..',
    '...W.WWWWWWW.W..',
    '...WWWWRWRWWWW..',
    '...WW.RR.RR.WW..',
    '...W.........W..',
  ];

  // Fiende type A (r√∏d)
  const SPR_ENEMY_R = [
    '.....R.....R.....',
    '......R...R......',
    '.....RRRRRRR.....',
    '....RRWRRRWRR....',
    '...RRRRRRRRRRR...',
    '...R.RRRRRRR.R...',
    '...R.R.....R.R...',
  ];
  // Fiende type B (gul)
  const SPR_ENEMY_Y = SPR_ENEMY_R.map(row=>row.replace(/R/g,'B'));
  // Fiende type C (gr√∏nn/bl√•)
  const SPR_ENEMY_G = SPR_ENEMY_R.map(row=>row.replace(/R/g,'G'));

  const SPR_BULLET = [
    '....',
    '.W..',
    '.W..',
    '.W..',
    '.W..',
    '....'
  ];
  const SPR_EBULLET = [
    '....',
    '.W..',
    '.W..',
    '.W..',
    '.W..',
    '....'
  ];

  function spriteForRow(r){ return r===0?SPR_ENEMY_R : (r<3?SPR_ENEMY_Y:SPR_ENEMY_G); }

  // --- Spilltilstand ------------------------------------------------------
  let score=0, wave=2, lives=5; let gameOver=false, youWin=false;
  const player={ x:W/2, y:H-56, w:32, h:32, speed:7.0, cooldown:1, invuln:0 };
  const shots=[], enemyShots=[], particles=[];

  // Fiendeformasjon
  const rows=5, cols=8; const enemies=[]; const sX=48, sY=36; const eStartX=56, eStartY=84;
  let enemyDX=0.9, stepDown=18, enemyFireTimer=1000, enemyDiveTimer=2200;

  function resetEnemies(){
    enemies.length=0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        enemies.push({ x:eStartX+c*sX, y:eStartY+r*sY, w:32, h:32, alive:true, row:r, mode:'formation', vx:0, vy:0 });
      }
    }
  }
  function startWave(n){
    wave=n; enemyDX=0.9*Math.pow(1.08,wave-1);
    enemyFireTimer=Math.max(380, 1000-(wave-1)*70);
    enemyDiveTimer=Math.max(1200, 2400-(wave-1)*160);
    resetEnemies();
  }
  startWave(1);

  // Input
  const keys={};
  addEventListener('keydown',e=>{ keys[e.code]=true; if(e.code==='KeyR') restart(); });
  addEventListener('keyup',e=>{ keys[e.code]=false; });

  function restart(){ score=0; lives=3; Object.assign(player,{x:W/2,y:H-56,cooldown:0,invuln:0}); shots.length=0; enemyShots.length=0; particles.length=0; gameOver=false; youWin=false; startWave(1); }

  // Verkt√∏y
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
  function rect(a,b){ return !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h); }

  function firePlayer(){ if(player.cooldown>0) return; shots.push({x:player.x-2,y:player.y-10,w:8,h:12,vy:-6}); player.cooldown=160; b(720,0.04,'square',0.035); }
  function fireEnemy(){ const alive=enemies.filter(e=>e.alive); if(!alive.length) return; alive.sort((a,b)=>b.y-a.y); const choice=alive[Math.floor(Math.random()*Math.min(6,alive.length))]; enemyShots.push({x:choice.x+choice.w/2-2,y:choice.y+choice.h,w:8,h:12,vy:3+0.15*wave}); b(240,0.05,'triangle',0.03); }

  function explode(x,y,color){ for(let i=0;i<18;i++){ const a=Math.random()*Math.PI*2; const sp=1+Math.random()*3; particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:420,color}); } }

  // Loop
  let last=performance.now(); requestAnimationFrame(function loop(t){ const dt=t-last; last=t; update(dt); draw(); requestAnimationFrame(loop); });

  function update(dt){
    if(gameOver||youWin) return;

    // Spiller
    if(keys['ArrowLeft']||keys['KeyA']) player.x-=player.speed;
    if(keys['ArrowRight']||keys['KeyD']) player.x+=player.speed;
    player.x=clamp(player.x,24,W-24);
    if(keys['Space']) firePlayer();
    if(player.cooldown>0) player.cooldown-=dt; if(player.invuln>0) player.invuln-=dt;

    // Skudd
    for(let i=shots.length-1;i>=0;i--){ const s=shots[i]; s.y+=s.vy; if(s.y+s.h<0) shots.splice(i,1); }
    for(let i=enemyShots.length-1;i>=0;i--){ const s=enemyShots[i]; s.y+=s.vy; if(s.y>H) enemyShots.splice(i,1); }

    // Partikler
    for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.015; p.life-=dt; if(p.life<=0) particles.splice(i,1); }

    // Fiender
    let minX=Infinity,maxX=-Infinity, anyAlive=false;
    for(const e of enemies){ if(!e.alive) continue; anyAlive=true; if(e.mode==='formation'){ e.x+=enemyDX; minX=Math.min(minX,e.x); maxX=Math.max(maxX,e.x+e.w); } else { const steer=((player.x-e.x)*0.0025)*dt; e.vx=clamp(e.vx+steer,-2.2,2.2); e.vy=clamp(e.vy+0.0025*dt,2.2,5.2); e.x+=e.vx; e.y+=e.vy; if(e.y>H+40){ e.y=84-20; e.mode='formation'; e.vx=0; e.vy=0; } } }
    if(anyAlive && (minX<16||maxX>W-16)){ enemyDX=-enemyDX; for(const e of enemies){ if(e.alive && e.mode==='formation') e.y+=stepDown; } enemyDX*=1.05; }

    // Treff: spiller ‚Üí fiende
    for(let i=shots.length-1;i>=0;i--){ const s=shots[i]; let hit=false; for(const e of enemies){ if(!e.alive) continue; if(rect({x:s.x,y:s.y,w:s.w,h:s.h}, e)){ e.alive=false; score+=10; explode(e.x+e.w/2,e.y+e.h/2,'#ffd166'); b(560,0.05,'sawtooth',0.035); hit=true; break; } } if(hit) shots.splice(i,1); }

    // Treff: fiendekule/dykker ‚Üí spiller
    const playerBox={x:player.x-16,y:player.y-12,w:32,h:28};
    if(player.invuln<=0){
      for(let i=enemyShots.length-1;i>=0;i--){ const s=enemyShots[i]; if(rect({x:s.x,y:s.y,w:s.w,h:s.h}, playerBox)){ enemyShots.splice(i,1); explode(player.x,player.y,'#8bffd1'); loseLife(); break; } }
      for(const e of enemies){ if(e.alive && e.mode==='formation' && e.y+e.h>=player.y){ gameOver=true; } }
      for(const e of enemies){ if(e.alive && e.mode!=='formation' && rect(playerBox, e)){ e.alive=false; explode(player.x,player.y,'#8bffd1'); loseLife(); break; } }
    }

    // B√∏lge ferdig?
    if(enemies.every(e=>!e.alive)) { if(wave>=3){ youWin=true; b(880,0.18,'triangle',0.05); } else nextWave(); }

    // Timere
    enemyFireTimer-=dt; if(enemyFireTimer<=0){ fireEnemy(); enemyFireTimer=Math.max(220, 900-wave*80); }
    enemyDiveTimer-=dt; if(enemyDiveTimer<=0){ launchDiver(); enemyDiveTimer=Math.max(800, 2200-wave*140); }
  }

  function launchDiver(){ const cand=enemies.filter(e=>e.alive && e.mode==='formation'); if(!cand.length) return; cand.sort((a,b)=>a.row-b.row || Math.random()-0.5); const e=cand[0]; e.mode='dive'; e.vx=(Math.random()<0.5?-1:1)*1.2; e.vy=2.2; b(300,0.08,'sine',0.04); }
  function loseLife(){ lives--; b(220,0.08,'square',0.06); if(lives<=0){ gameOver=true; return; } player.x=W/2; player.invuln=1500; }
  function nextWave(){ shots.length=0; enemyShots.length=0; particles.length=0; startWave(wave+1); b(660,0.1,'triangle',0.04); }

  // Tegning ----------------------------------------------------------------
  function draw(){
    // Bakgrunn stjerner
    ctx.fillStyle='#050814'; ctx.fillRect(0,0,W,H);
    for(let i=0;i<70;i++){ const x=(i*67%W); const y=(i*131%H); ctx.fillStyle=i%7===0?'#7dd3fc':'#93c5fd'; ctx.fillRect((x+performance.now()/70)%W, y, 2, 2); }

    // UI
    ctx.fillStyle='#e7eefc'; ctx.font='16px system-ui, sans-serif';
    ctx.fillText('SCORE: '+score,16,24); ctx.fillText('WAVE: '+wave, W/2-28,24); ctx.fillText('LIV: '+lives, W-90,24);

    // Spiller
    if(!(player.invuln>0 && Math.floor(performance.now()/120)%2===0))
      drawSprite(SPR_PLAYER, Math.round(player.x-16), Math.round(player.y-16), 2);

    // Skudd
    for(const s of shots){ drawSprite(SPR_BULLET, Math.round(s.x-2), Math.round(s.y-6), 2); }
    for(const s of enemyShots){ drawSprite(SPR_EBULLET, Math.round(s.x-2), Math.round(s.y-6), 2); }

    // Fiender
    for(const e of enemies){ if(!e.alive) continue; const spr=spriteForRow(e.row); drawSprite(spr, Math.round(e.x-16), Math.round(e.y-16), 2); }

    // Partikler
    for(const p of particles){ ctx.fillStyle=p.color; ctx.fillRect(p.x, p.y, 2, 2); }

    if(gameOver||youWin){ ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(0,0,W,H); ctx.fillStyle=youWin?'#7ef29a':'#ff8fa3'; ctx.font='bold 28px system-ui, sans-serif'; ctx.textAlign='center'; ctx.fillText(youWin?'SEIER! üéâ':'GAME OVER',W/2,H/2-12); ctx.font='16px system-ui, sans-serif'; ctx.fillStyle='#e7eefc'; ctx.fillText('Trykk R for √• restarte', W/2, H/2+16); ctx.textAlign='start'; }
  }

  </script>
</body>
</html>
